<template>
    <!-- Modal Container -->
    <template if:true={showModal}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading" aria-modal="true" 
                 class="slds-modal slds-fade-in-open slds-modal_large">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                            title="Close" onclick={handleClose}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 id="modal-heading" class="slds-modal__title slds-hyphenate">
                        {modalTitle}
                    </h2>
                    <template if:true={caseSummary}>
                        <p class="slds-m-top_x-small slds-text-body_small slds-text-color_weak">
                            Case: {caseSummary.caseNumber}
                        </p>
                    </template>
                </header>

                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium">
                    <!-- Loading State -->
                    <template if:true={isLoading}>
                        <div class="slds-align_absolute-center slds-p-vertical_large">
                            <lightning-spinner alternative-text="Loading duplicate matches..." size="medium"></lightning-spinner>
                            <div class="slds-m-top_small slds-text-color_weak">Loading all duplicate matches...</div>
                        </div>
                    </template>

                    <!-- Error State -->
                    <template if:true={error}>
                        <div class="slds-notify slds-notify_alert slds-alert_error">
                            <span class="slds-assistive-text">Error</span>
                            <h2 class="slds-text-heading_small">
                                Unable to load duplicate matches
                            </h2>
                            <p class="slds-m-top_x-small">
                                {error.body.message}
                            </p>
                        </div>
                    </template>

                    <!-- Main Content -->
                    <template if:false={isLoading}>
                        <!-- Toolbar -->
                        <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
                            <div class="slds-col">
                                <lightning-button-group>
                                    <lightning-button
                                        label={filtersToggleLabel}
                                        icon-name={filtersToggleIcon}
                                        onclick={handleFiltersToggle}
                                        variant="neutral">
                                    </lightning-button>
                                    <lightning-button
                                        label="Clear Filters"
                                        icon-name="utility:clear"
                                        onclick={handleClearFilters}
                                        variant="neutral">
                                    </lightning-button>
                                    <lightning-button
                                        label="Export CSV"
                                        icon-name="utility:download"
                                        onclick={handleExportCSV}
                                        variant="neutral"
                                        disabled={isLoading}>
                                    </lightning-button>
                                </lightning-button-group>
                            </div>
                        </div>

                        <!-- Filters Panel -->
                        <template if:true={showFilters}>
                            <div class="slds-card slds-m-bottom_medium">
                                <div class="slds-card__header">
                                    <h3 class="slds-card__header-title">Filters & Sorting</h3>
                                </div>
                                <div class="slds-card__body slds-p-horizontal_medium">
                                    <div class="slds-grid slds-wrap slds-gutters">
                                        <!-- Match Type Filter -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <lightning-combobox
                                                name="matchType"
                                                label="Match Type"
                                                value={selectedMatchType}
                                                placeholder="Select match type"
                                                options={matchTypeOptions}
                                                onchange={handleMatchTypeChange}>
                                            </lightning-combobox>
                                        </div>

                                        <!-- Sort Field -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <lightning-combobox
                                                name="sortField"
                                                label="Sort By"
                                                value={sortField}
                                                placeholder="Select sort field"
                                                options={sortFieldOptions}
                                                onchange={handleSortFieldChange}>
                                            </lightning-combobox>
                                        </div>

                                        <!-- Sort Direction -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <div class="slds-form-element">
                                                <label class="slds-form-element__label">Sort Direction</label>
                                                <div class="slds-form-element__control">
                                                    <lightning-button
                                                        label={sortDirection}
                                                        icon-name="utility:arrowup"
                                                        onclick={handleSortDirectionToggle}
                                                        variant="neutral"
                                                        class="sort-direction-button">
                                                    </lightning-button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Search -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3">
                                            <lightning-input
                                                data-id="search"
                                                type="search"
                                                label="Search"
                                                placeholder="Search by record name, bill ID, procedure code, or patient ID..."
                                                value={searchTerm}
                                                onchange={handleSearchChange}>
                                            </lightning-input>
                                        </div>

                                        <!-- Group By -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <div class="slds-form-element">
                                                <label class="slds-form-element__label">Display Options</label>
                                                <div class="slds-form-element__control">
                                                    <lightning-input
                                                        type="checkbox"
                                                        label="Group by Match Type"
                                                        checked={groupByMatchType}
                                                        onchange={handleGroupByToggle}>
                                                    </lightning-input>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- No Matches State -->
                        <template if:false={hasMatches}>
                            <div class="slds-align_absolute-center slds-p-vertical_large">
                                <lightning-icon icon-name="utility:search" size="large" variant="neutral"></lightning-icon>
                                <h3 class="slds-text-heading_medium slds-m-top_medium">No duplicate matches found</h3>
                                <p class="slds-text-body_regular slds-text-color_weak slds-m-top_small">
                                    Try adjusting your filters or search criteria.
                                </p>
                            </div>
                        </template>

                        <!-- Matches Display -->
                        <template if:true={hasMatches}>
                            <template for:each={groupedMatches} for:item="group">
                                <div key={group.groupTitle} class={group.groupClass}>
                                    <!-- Group Header -->
                                    <template if:true={group.groupTitle}>
                                        <div class="slds-section slds-is-open">
                                            <h3 class="slds-section__title slds-theme_shade">
                                                <span class="slds-truncate slds-p-horizontal_small" title={group.groupTitle}>
                                                    {group.groupTitle}
                                                </span>
                                            </h3>
                                        </div>
                                    </template>

                                    <!-- Matches List -->
                                    <div class="matches-container">
                                        <template for:each={group.matches} for:item="match">
                                            <div key={match.recordId} class="match-card slds-card slds-m-bottom_small">
                                                <div class="slds-card__body slds-p-around_small">
                                                    <div class="slds-grid slds-grid_align-spread">
                                                        <!-- Match Details -->
                                                        <div class="slds-col slds-size_3-of-4">
                                                            <div class="slds-grid slds-wrap slds-gutters_x-small">
                                                                <!-- Record Name & Match Type -->
                                                                <div class="slds-col slds-size_1-of-1">
                                                                    <h4 class="slds-text-heading_small">
                                                                        <lightning-button
                                                                            label={match.recordName}
                                                                            variant="base"
                                                                            data-record-id={match.recordId}
                                                                            onclick={handleNavigateToLineItem}
                                                                            class="record-link">
                                                                        </lightning-button>
                                                                        <lightning-badge 
                                                                            label={match.matchTypeLabel}
                                                                            class="slds-m-left_x-small match-type-badge">
                                                                        </lightning-badge>
                                                                    </h4>
                                                                </div>

                                                                <!-- Details Grid -->
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Confidence:</span>
                                                                        <span class="detail-value">{match.confidenceLabel}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Charge:</span>
                                                                        <span class="detail-value">{match.formattedChargeAmount}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Service Date:</span>
                                                                        <span class="detail-value">{match.formattedServiceDates}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Procedure:</span>
                                                                        <span class="detail-value">{match.procedureCode}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Bill ID:</span>
                                                                        <span class="detail-value">{match.billExternalId}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                                                                    <div class="detail-item">
                                                                        <span class="detail-label">Patient:</span>
                                                                        <span class="detail-value">{match.patientId}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Actions -->
                                                        <div class="slds-col slds-size_1-of-4 slds-text-align_right">
                                                            <template if:true={match.caseId}>
                                                                <lightning-button
                                                                    label="View Case"
                                                                    variant="neutral"
                                                                    size="small"
                                                                    data-case-id={match.caseId}
                                                                    onclick={handleNavigateToCase}
                                                                    class="slds-m-bottom_x-small">
                                                                </lightning-button>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </template>
                </div>

                <!-- Modal Footer -->
                <footer class="slds-modal__footer">
                    <lightning-button
                        label="Close"
                        variant="neutral"
                        onclick={handleClose}>
                    </lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>